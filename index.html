<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coordinamento Attività Giovani · UP Valmessa</title>
  <style>
    :root { --bg:#ffffff; --card:#ffffff; --muted:#6b7280; --text:#111827; --accent:#2563eb; --border:#e5e7eb; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#f3f4f6;color:var(--text)}
    .app{max-width:1200px;margin:0 auto;padding:16px;display:grid;gap:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .brand{display:flex;flex-direction:column;gap:4px}
    .brand .title{font-weight:800;letter-spacing:.2px}
    .brand .subtitle{font-size:13px;color:var(--muted)}
    .btn{background:#ffffff;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
    .btn.icon{padding:8px 10px}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .pane{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.05)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){.grid{grid-template-columns:420px 1fr}}
    textarea,input[type=text],input[type=color],select{width:100%;background:#ffffff;color:#111827;border:1px solid var(--border);border-radius:12px;padding:10px 12px;font:inherit}
    textarea{min-height:130px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 140px 110px auto;gap:8px;align-items:center}
    .row-2col{display:grid;grid-template-columns:1fr 220px;gap:8px}
    .stack{display:flex;flex-direction:column;gap:8px}
    .label-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#f9fafb;padding:6px 8px;border-radius:10px;font-size:12px}
    .pill .dot{width:10px;height:10px;border-radius:50%}
    .pill .del{cursor:pointer;background:#fff;border-radius:6px;padding:2px 6px;border:1px solid var(--border)}

    .topbar{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .seg{display:inline-flex;background:#f3f4f6;border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .seg button{border:0;background:transparent;padding:6px 10px;font-weight:600;cursor:pointer}
    .seg button.active{background:#fff;border-left:1px solid var(--border);border-right:1px solid var(--border)}

    .monthtitle{font-weight:700}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .dow{text-align:center;font-size:12px;color:var(--muted);padding:6px 0}
    .day{background:#ffffff;border:1px solid var(--border);border-radius:12px;min-height:170px;padding:6px;display:flex;flex-direction:column;gap:6px;cursor:pointer}
    .day .num{font-size:12px;color:#6b7280;display:flex;align-items:center;justify-content:space-between}
    .day.today{outline:2px solid var(--accent)}
    .events{display:flex;flex-direction:column;gap:4px}
    .ev{display:flex;align-items:center;gap:6px;background:#f9fafb;border:1px solid var(--border);border-radius:10px;padding:4px 6px;font-size:11px;cursor:pointer}
    .ev .dot{width:10px;height:10px;border-radius:50%}
    .more{font-size:11px;color:var(--accent);cursor:pointer;user-select:none}

    /* Week view */
    .week-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .week-col{background:#fff;border:1px solid var(--border);border-radius:12px;min-height:260px;padding:6px;display:flex;flex-direction:column;gap:6px}
    .week-head{font-size:12px;color:#6b7280;display:flex;justify-content:space-between}

    /* Day view */
    .daylist{display:flex;flex-direction:column;gap:8px}
    .dayitem{display:flex;gap:8px;align-items:flex-start;background:#fff;border:1px solid var(--border);border-radius:12px;padding:8px}
    .timebadge{min-width:54px;text-align:center;font-weight:700;border:1px solid var(--border);border-radius:8px;padding:4px 6px;background:#f9fafb}
    .labelbadge{display:inline-flex;gap:6px;align-items:center;padding:2px 6px;border:1px solid var(--border);border-radius:999px;background:#f9fafb;font-size:12px;margin-left:6px}
    .labelbadge .dot{width:10px;height:10px;border-radius:50%}

    .muted{font-size:12px;color:var(--muted)}
    .note{background:#fff8e1;border:1px dashed #f59e0b;padding:8px 10px;border-radius:10px;color:#7c5f15;font-size:12px}
    .disabled{opacity:.55;pointer-events:none}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(17,24,39,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal.show{display:flex}
    .dialog{background:#fff;border:1px solid var(--border);border-radius:16px;max-width:560px;width:100%;padding:16px;display:flex;flex-direction:column;gap:12px}
    .dialog-footer{display:flex;gap:8px;justify-content:flex-end}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="title">Coordinamento Attività Giovani</div>
        <div class="subtitle">UP Valmessa</div>
      </div>
    </header>

    <!-- 0) Sblocco editor -->
    <section class="pane">
      <h3>0) Permessi</h3>
      <div class="stack">
        <div style="display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center">
          <input id="calId" type="text" placeholder="ID calendario" readonly />
          <button class="btn" id="createCalBtn">Crea calendario</button>
          <button class="btn" id="copyViewerBtn">Copia link (solo visualizza)</button>
        </div>
        <div style="display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center">
          <input id="editCodeInput" type="text" placeholder="Codice editor" />
          <button class="btn" id="unlockBtn">Sblocca editor</button>
          <button class="btn" id="copyEditorLinkBtn">Copia link editor</button>
        </div>
        <div class="muted"><span id="codeStatus">Codice editor fissato: VIVAGESU</span></div>
        <p class="muted" id="cloudStatus">Cloud: non connesso</p>
        <p class="note">Tocca un giorno per la <b>lista completa</b> senza lasciare la vista Mese. Per modificare: <b>?id=…</b> + <b>codice editor</b>.</p>
      </div>
    </section>

    <div class="grid">
      <!-- Sinistra: input -->
      <section class="pane">
        <h3>1) Incolla righe (data + ora facoltativa + titolo)</h3>
        <textarea id="datesInput" placeholder="Esempi (una per riga):
- riunione 28 settembre
- incontro 19 ottobre
- attività 23 novembre
- festa 4 gennaio
- laboratorio 8 febbraio
- uscita 15 marzo
- gita 7 giugno
Anche: 25/12 10:30 evento | 25-12 pranzo | 25/12/2026 10:30 - celebrazione | 2026-12-31 veglione ore 21"></textarea>
        <p class="muted">Date: <b>DD/MM</b>, <b>DD-MM</b>, <b>DD/MM/YYYY</b>, <b>YYYY-MM-DD</b>, <b>D mese</b> o <b>mese D</b>. Se manca l'anno e il giorno è già passato → uso l'anno prossimo. Ore: <b>HH:MM</b>, <b>HH.MM</b>, <b>ore HH(:MM)</b>, <b>h HH(:MM)</b>, <b>alle HH(:MM)</b>.</p>

        <h3>2) Etichette</h3>
        <div class="row">
          <select id="labelSelect"></select>
          <input id="newLabel" type="text" placeholder="Nuova etichetta" />
          <input id="newColor" type="color" value="#2563eb" />
          <button class="btn" id="addLabelBtn">+ Etichetta</button>
        </div>
        <div class="label-list" id="labels"></div>

        <button class="btn primary" style="margin-top:10px;" id="addDatesBtn">Aggiungi date al calendario</button>
      </section>

      <!-- Destra: calendario -->
      <section class="pane">
        <div class="topbar">
          <div class="seg" role="tablist" aria-label="Vista calendario">
            <button class="active" id="viewMonthBtn" aria-selected="true">Mese</button>
            <button id="viewWeekBtn" aria-selected="false">Settimana</button>
            <button id="viewDayBtn" aria-selected="false">Giorno</button>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <button class="btn icon" id="prevBtn" aria-label="Periodo precedente">◀</button>
            <div class="monthtitle" id="monthLabel"></div>
            <button class="btn icon" id="nextBtn" aria-label="Periodo successivo">▶</button>
            <button class="btn" id="todayBtn">Oggi</button>
          </div>
        </div>

        <div class="row-2col" style="margin-bottom:6px">
          <input id="searchInput" type="text" placeholder="Cerca titolo o note…" />
          <select id="filterLabel"><option value="">Tutte le etichette</option></select>
        </div>
        <div class="row-2col" style="margin-bottom:6px">
          <label class="muted" for="dayClickMode">Click sul giorno</label>
          <select id="dayClickMode">
            <option value="modal">Apri finestra (consigliato)</option>
            <option value="view">Vai alla vista Giorno</option>
          </select>
        </div>

        <div id="monthWrap">
          <div class="cal-grid" id="dow"></div>
          <div class="cal-grid" id="calendar"></div>
        </div>

        <div id="weekWrap" style="display:none">
          <div class="week-grid" id="weekGrid"></div>
        </div>

        <div id="dayWrap" style="display:none">
          <div class="daylist" id="dayList"></div>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center">
          <button class="btn" id="exportIcsBtn">Esporta ICS (Google/Apple)</button>
          <span class="muted" id="countInfo"></span>
          <span class="muted" id="permInfo" style="margin-left:auto"></span>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal Evento -->
  <div class="modal" id="eventModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <h3 style="margin:0">Dettagli evento</h3>
        <button class="btn icon" id="closeModalBtn" aria-label="Chiudi">✕</button>
      </div>
      <div class="stack">
        <input id="evTitleInput" type="text" placeholder="Titolo evento" />
        <div class="row-2col">
          <div><label class="muted">Data</label><div id="evDate"></div></div>
          <div><label class="muted">Ora</label><input id="evTimeInput" type="text" placeholder="es. 21:00" /></div>
        </div>
        <div><span class="muted">Etichetta</span> <span class="pill"><span class="dot" id="evDot"></span><span id="evLabel"></span></span></div>
        <div>
          <label class="muted" for="evNote">Note condivise</label>
          <textarea id="evNote" placeholder="Aggiungi dettagli utili (visibili a tutti)"></textarea>
        </div>
      </div>
      <div class="dialog-footer">
        <button class="btn" id="deleteEventBtn" style="margin-right:auto;display:none">Elimina</button>
        <button class="btn" id="cancelBtn">Annulla</button>
        <button class="btn primary" id="saveNoteBtn">Salva</button>
      </div>
    </div>
  </div>

  <!-- Modal Giorno (lista completa) -->
  <div class="modal" id="dayModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <h3 id="dayModalTitle" style="margin:0">Eventi del giorno</h3>
        <button class="btn icon" id="closeDayModalBtn" aria-label="Chiudi">✕</button>
      </div>
      <div class="daylist" id="dayModalList" style="max-height:60vh;overflow:auto"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBFQSeogcXUDOlxvRyxQcsjSMy1g-nkS0g",
      authDomain: "calendario-ef258.firebaseapp.com",
      projectId: "calendario-ef258",
      storageBucket: "calendario-ef258.appspot.com",
      messagingSenderId: "729616112481",
      appId: "1:729616112481:web:1fec0202ffcb45c85b84320"
    };

    const app = initializeApp(firebaseConfig);
    const EDITOR_CODE = 'VIVAGESU';
    const db = getFirestore(app);

    const $ = (s)=>document.querySelector(s);
    const pad = (n)=> n.toString().padStart(2,'0');

    function genId(){ const arr=new Uint8Array(10); crypto.getRandomValues(arr); return Array.from(arr,b=>b.toString(16).padStart(2,'0')).join(''); }
    function genEid(){ const arr=new Uint8Array(8); crypto.getRandomValues(arr); return Array.from(arr,b=>b.toString(16).padStart(2,'0')).join(''); }

    const MONTHS_IT = { 'gennaio':0,'gen':0,'febbraio':1,'feb':1,'marzo':2,'mar':2,'aprile':3,'apr':3,'maggio':4,'mag':4,'giugno':5,'giu':5,'luglio':6,'lug':6,'agosto':7,'ago':7,'settembre':8,'set':8,'sett':8,'ottobre':9,'ott':9,'novembre':10,'nov':10,'dicembre':11,'dic':11 };

    function inferYear(monthIdx, day){ const today=new Date(); let y=today.getFullYear(); const candidate=new Date(y, monthIdx, day); const todayMid=new Date(today.getFullYear(), today.getMonth(), today.getDate()); if (candidate < todayMid) y++; return new Date(y, monthIdx, day); }

    function parseDateToken(t){ t=t.trim(); let m=t.match(/^([0-3]?\d)[\/-]([0-1]?\d)[\/-](\d{4})$/); if(m){ const d=+m[1], mo=+m[2], y=+m[3]; const dt=new Date(y,mo-1,d); return isNaN(dt)?null:dt; } m=t.match(/^(\d{4})[\/-]([0-1]?\d)[\/-]([0-3]?\d)$/); if(m){ const y=+m[1], mo=+m[2], d=+m[3]; const dt=new Date(y,mo-1,d); return isNaN(dt)?null:dt; } return null; }

    function parseMonthNameDate(line){ const monthsRegex = Object.keys(MONTHS_IT).join('|'); const dayMonthRe = new RegExp(`\\b(\\d{1,2})\\s+(${monthsRegex})\\b`, 'i'); const monthDayRe = new RegExp(`\\b(${monthsRegex})\\s+(\\d{1,2})\\b`, 'i'); let m = dayMonthRe.exec(line); if (!m) m = monthDayRe.exec(line); if (!m) return null; let day, monthName, matchText=m[0], idx=m.index; if (m.length===3){ day = parseInt(m[1],10); monthName = m[2].toLowerCase(); } else { monthName = m[1].toLowerCase(); day = parseInt(m[2],10); } const monthIdx = MONTHS_IT[monthName]; if (monthIdx==null || !(day>=1 && day<=31)) return null; const dt = inferYear(monthIdx, day); return {dt, matchText, index: idx}; }

    function parseNumericNoYear(line){ const re = /(\b\d{1,2})[\/-](\d{1,2})(?![\/-]\d)/; const m = re.exec(line); if (!m) return null; const day = parseInt(m[1],10), mo = parseInt(m[2],10); if (!(day>=1 && day<=31) || !(mo>=1 && mo<=12)) return null; const dt = inferYear(mo-1, day); return { dt, matchText: m[0], index: m.index }; }

    function extractTime(s){ const candidates=[]; let m = s.match(/\b([01]?\d|2[0-3]):([0-5]\d)\b/); if (m) candidates.push({text:`${m[1].padStart(2,'0')}:${m[2]}`, index:m.index, len:m[0].length}); m = s.match(/\b([01]?\d|2[0-3])\.([0-5]\d)\b/); if (m) candidates.push({text:`${m[1].padStart(2,'0')}:${m[2]}`, index:m.index, len:m[0].length}); m = s.match(/\bore\s+([01]?\d|2[0-3])(?::([0-5]\d))?/i); if (m) candidates.push({text:`${m[1].padStart(2,'0')}:${(m[2]||'00')}`, index:m.index, len:m[0].length}); m = s.match(/\bh\s*([01]?\d|2[0-3])(?::([0-5]\d))?/i); if (m) candidates.push({text:`${m[1].padStart(2,'0')}:${(m[2]||'00')}`, index:m.index, len:m[0].length}); m = s.match(/\balle\s+(?:ore\s+)?([01]?\d|2[0-3])(?::([0-5]\d))?/i); if (m) candidates.push({text:`${m[1].padStart(2,'0')}:${(m[2]||'00')}`, index:m.index, len:m[0].length}); if (!candidates.length) return null; candidates.sort((a,b)=>a.index-b.index); const c=candidates[0]; return { text:c.text, index:c.index, len:c.len }; }

    function parseLine(line){ line = line.replace(/^\s*[\-–•]\s*/, ''); const numDateRe = /(\b\d{1,2}[\/-]\d{1,2}[\/-]\d{4}\b)|(\b\d{4}[\/-]\d{1,2}[\/-]\d{1,2}\b)/; let m = numDateRe.exec(line); let dt=null, dateToken=null, dateIdx=-1; if (m){ dateToken=m[0]; dt=parseDateToken(dateToken); dateIdx=m.index; } if (!dt){ const mm = parseNumericNoYear(line); if (mm){ dt=mm.dt; dateToken=mm.matchText; dateIdx=mm.index; } } if (!dt){ const mon = parseMonthNameDate(line); if (mon){ dt=mon.dt; dateToken=mon.matchText; dateIdx=mon.index; } } if (!dt) return null; let remainder = line.slice(0, dateIdx) + line.slice(dateIdx + dateToken.length); const t = extractTime(remainder); if (t){ remainder = remainder.slice(0, t.index) + remainder.slice(t.index + t.len); } let titlePart = remainder.replace(/^[\s,;:\-–|]+|[\s,;:\-–|]+$/g, '').replace(/\s{2,}/g,' ').trim(); return { date: `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`, time: t? t.text : '', title: titlePart }; }

    function normalizeTime(input){ const s=(input||'').trim(); if (!s) return ''; let m; if (m=s.match(/^([01]?\d|2[0-3]):([0-5]\d)$/)) return `${pad(m[1])}:${m[2]}`; if (m=s.match(/^([01]?\d|2[0-3])\.([0-5]\d)$/)) return `${pad(m[1])}:${m[2]}`; if (m=s.match(/^(?:ore\s+)?([01]?\d|2[0-3])(?::([0-5]\d))?$/i)) return `${pad(m[1])}:${(m[2]||'00')}`; if (m=s.match(/^h\s*([01]?\d|2[0-3])(?::([0-5]\d))?$/i)) return `${pad(m[1])}:${(m[2]||'00')}`; if (m=s.match(/^alle\s+(?:ore\s+)?([01]?\d|2[0-3])(?::([0-5]\d))?$/i)) return `${pad(m[1])}:${(m[2]||'00')}`; return null; }

    const state = { current: new Date(), selected: new Date(), view:'month', events: [], labels: [], calId: '', canEdit: false, editCode: '', unsub: null, lastLabel:'', modalEventId:null, searchQuery:'', filterLabel:'' };

    // Refs input
    const datesInput=$('#datesInput'); const labelSelect=$('#labelSelect'); const newLabel=$('#newLabel'); const newColor=$('#newColor'); const addLabelBtn=$('#addLabelBtn'); const labelsWrap=$('#labels'); const calIdEl=$('#calId'); const editCodeInput=$('#editCodeInput'); const permInfo=$('#permInfo'); const searchInput=$('#searchInput'); const filterLabelEl=$('#filterLabel'); const dayClickModeEl=$('#dayClickMode');
    // View buttons
    const viewMonthBtn=$('#viewMonthBtn'), viewWeekBtn=$('#viewWeekBtn'), viewDayBtn=$('#viewDayBtn');
    // Modals
    const eventModal=$('#eventModal'); const closeModalBtn=$('#closeModalBtn'); const cancelBtn=$('#cancelBtn'); const saveNoteBtn=$('#saveNoteBtn'); const deleteEventBtn=$('#deleteEventBtn'); const evTitleInput=$('#evTitleInput'); const evDate=$('#evDate'); const evTimeInput=$('#evTimeInput'); const evLabel=$('#evLabel'); const evDot=$('#evDot'); const evNote=$('#evNote');
    const dayModal=$('#dayModal'); const closeDayModalBtn=$('#closeDayModalBtn'); const dayModalTitle=$('#dayModalTitle'); const dayModalList=$('#dayModalList');

    function updateCodeStatus(){ const el=$('#codeStatus'); if(el) el.textContent = 'Codice editor fissato: VIVAGESU'; }

    // Preferenza locale: comportamento click giorno (modal vs vista Giorno)
    const savedMode = localStorage.getItem('dayClickMode') || 'modal';
    state.dayClickMode = savedMode;
    if (dayClickModeEl){
      dayClickModeEl.value = state.dayClickMode;
      dayClickModeEl.addEventListener('change', ()=>{
        state.dayClickMode = dayClickModeEl.value;
        localStorage.setItem('dayClickMode', state.dayClickMode);
      });
    }

    function matchesFilters(e){ if (state.filterLabel && e.label !== state.filterLabel) return false; if (state.searchQuery){ const hay = `${e.title||''} ${e.note||''} ${e.time||''}`.toLowerCase(); if (!hay.includes(state.searchQuery)) return false; } return true; }

    function renderFilterLabelOptions(){ const prev=state.filterLabel; filterLabelEl.innerHTML=''; const any=document.createElement('option'); any.value=''; any.textContent='Tutte le etichette'; filterLabelEl.appendChild(any); state.labels.forEach(l=>{ const o=document.createElement('option'); o.value=l.name; o.textContent=l.name; filterLabelEl.appendChild(o); }); filterLabelEl.value=prev||''; }

    function setView(v){ state.view=v; viewMonthBtn.classList.toggle('active',v==='month'); viewWeekBtn.classList.toggle('active',v==='week'); viewDayBtn.classList.toggle('active',v==='day'); $('#monthWrap').style.display = v==='month'? 'block':'none'; $('#weekWrap').style.display = v==='week'? 'block':'none'; $('#dayWrap').style.display = v==='day'? 'block':'none'; render(); }

    function formatRange(d1,d2){ const opts={day:'2-digit',month:'short'}; const s1=d1.toLocaleDateString('it-IT',opts); const s2=d2.toLocaleDateString('it-IT',opts); const y1=d1.getFullYear(), y2=d2.getFullYear(); return y1===y2? `${s1} – ${s2} ${y1}` : `${s1} ${y1} – ${s2} ${y2}`; }

    function startOfWeek(d){ const x=new Date(d); const wd=(x.getDay()+6)%7; x.setDate(x.getDate()-wd); x.setHours(0,0,0,0); return x; }

    function isoDate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }

    function eventsOnDateISO(iso){ return state.events.filter(e=>e.date===iso && matchesFilters(e)); }

    function render(){ if (state.view==='month') renderMonth(); else if (state.view==='week') renderWeek(); else renderDay(); updateCodeStatus(); renderLabels(); renderLabelSelect(); renderFilterLabelOptions(); applyEditability(); }

    function renderMonth(){ const y=state.current.getFullYear(); const m=state.current.getMonth(); $('#monthLabel').textContent = state.current.toLocaleDateString('it-IT',{month:'long',year:'numeric'}); const dow=$('#dow'), grid=$('#calendar'); dow.innerHTML=''; grid.innerHTML=''; ['Lun','Mar','Mer','Gio','Ven','Sab','Dom'].forEach(n=>{ const el=document.createElement('div'); el.className='dow'; el.textContent=n; dow.appendChild(el); }); const first=new Date(y,m,1), last=new Date(y,m+1,0); const start=((first.getDay()+6)%7); for(let i=0;i<start;i++) grid.appendChild(document.createElement('div')); const todayIso=isoDate(new Date()); const eventsInMonth=state.events.filter(e=>{ const d=new Date(e.date); return d.getFullYear()===y && d.getMonth()===m; }); const shown=eventsInMonth.filter(matchesFilters); const MAX_SHOW = window.innerWidth<420? 3 : 4; for(let d=1; d<=last.getDate(); d++){ const id=`${y}-${pad(m+1)}-${pad(d)}`; const cell=document.createElement('div'); cell.className='day'+(id===todayIso?' today':''); cell.addEventListener('click',()=>{ state.selected=new Date(y,m,d); if(state.dayClickMode==='view'){ setView('day'); } else { openDayModal(id); } }); const eventsForDay = shown.filter(e=>e.date===id).sort(sortByTimeThenTitle); const top=document.createElement('div'); top.className='num'; top.innerHTML=`<span>${d}</span><span>${eventsForDay.length||''}</span>`; cell.appendChild(top); const wrap=document.createElement('div'); wrap.className='events'; eventsForDay.slice(0,MAX_SHOW).forEach(ev=>{ const row=document.createElement('div'); row.className='ev'; row.addEventListener('click', (e)=>{ e.stopPropagation(); openEvent(ev.eid); }); const dot=document.createElement('span'); dot.className='dot'; dot.style.background=ev.color; row.appendChild(dot); const text=document.createElement('span'); text.textContent = `${ev.time? ev.time+' · ' : ''}${ev.title? ev.title : (ev.label||'Evento')}`; row.appendChild(text); wrap.appendChild(row); }); const rest = eventsForDay.length - MAX_SHOW; if (rest>0){ const more=document.createElement('div'); more.className='more'; more.textContent = `+${rest} altri`; more.addEventListener('click', (e)=>{ e.stopPropagation(); state.selected=new Date(y,m,d); if(state.dayClickMode==='view'){ setView('day'); } else { openDayModal(id); } }); wrap.appendChild(more); } cell.appendChild(wrap); grid.appendChild(cell); } const filtersActive=!!(state.searchQuery||state.filterLabel); $('#countInfo').textContent = filtersActive? `${shown.length} visibili · ${eventsInMonth.length} tot (mese)` : `${eventsInMonth.length} eventi nel mese`; }

    function renderWeek(){ const start=startOfWeek(state.selected); const days=[...Array(7)].map((_,i)=>{ const d=new Date(start); d.setDate(start.getDate()+i); return d; }); $('#monthLabel').textContent = `Settimana ${formatRange(days[0], days[6])}`; const grid=$('#weekGrid'); grid.innerHTML=''; days.forEach(d=>{ const iso=isoDate(d); const col=document.createElement('div'); col.className='week-col'; const head=document.createElement('div'); head.className='week-head'; head.innerHTML=`<span>${d.toLocaleDateString('it-IT',{weekday:'short'})}</span><span>${d.getDate()}</span>`; col.appendChild(head); const evs=eventsOnDateISO(iso).sort(sortByTimeThenTitle); if (!evs.length){ const empty=document.createElement('div'); empty.className='muted'; empty.textContent='—'; col.appendChild(empty); } else { evs.forEach(ev=>{ const row=document.createElement('div'); row.className='ev'; row.addEventListener('click',()=> openEvent(ev.eid)); const dot=document.createElement('span'); dot.className='dot'; dot.style.background=ev.color; row.appendChild(dot); const text=document.createElement('span'); text.textContent=`${ev.time? ev.time+' · ' : ''}${ev.title||ev.label||'Evento'}`; row.appendChild(text); col.appendChild(row); }); } col.addEventListener('click', (e)=>{ if (e.target===col) { state.selected=d; setView('day'); } }); grid.appendChild(col); }); const shown=days.reduce((n,d)=>n+eventsOnDateISO(isoDate(d)).length,0); $('#countInfo').textContent = `${shown} eventi nella settimana`; }

    function sortByTimeThenTitle(a,b){ const ta=a.time||'99:99', tb=b.time||'99:99'; if (ta<tb) return -1; if (ta>tb) return 1; return (a.title||'').localeCompare(b.title||''); }

    function renderDay(){ const d=state.selected; $('#monthLabel').textContent = d.toLocaleDateString('it-IT',{weekday:'long', day:'2-digit', month:'long', year:'numeric'}); const list=$('#dayList'); list.innerHTML=''; const evs=eventsOnDateISO(isoDate(d)).sort(sortByTimeThenTitle); if (!evs.length){ const empty=document.createElement('div'); empty.className='muted'; empty.textContent='Nessun evento per questo giorno'; list.appendChild(empty); } else { evs.forEach(ev=>{ const row=document.createElement('div'); row.className='dayitem'; row.addEventListener('click',()=> openEvent(ev.eid)); const time=document.createElement('div'); time.className='timebadge'; time.textContent = ev.time || 'Tutto il giorno'; const body=document.createElement('div'); const title=document.createElement('div'); title.style.fontWeight='700'; title.textContent = ev.title || '(senza titolo)'; const lab=document.createElement('span'); lab.className='labelbadge'; lab.innerHTML = `<span class="dot" style="background:${ev.color}"></span>${ev.label||'—'}`; body.appendChild(title); body.appendChild(lab); if (ev.note){ const note=document.createElement('div'); note.className='muted'; note.textContent=ev.note; body.appendChild(note); } row.appendChild(time); row.appendChild(body); list.appendChild(row); }); } $('#countInfo').textContent = `${evs.length} eventi nel giorno`; }

    function renderLabels(){ labelsWrap.innerHTML=''; state.labels.forEach(({name,color})=>{ const p=document.createElement('div'); p.className='pill'; const dot=document.createElement('span'); dot.className='dot'; dot.style.background=color; const txt=document.createElement('span'); txt.textContent=name; const del=document.createElement('span'); del.className='del'; del.textContent='Elimina'; del.addEventListener('click',()=>{ if(!state.canEdit) return; if(confirm(`Eliminare l'etichetta \"${name}\" dalla lista?`)){ state.labels = state.labels.filter(l=>l.name!==name); saveCloud(); renderLabelSelect(); renderFilterLabelOptions(); }}); p.appendChild(dot); p.appendChild(txt); p.appendChild(del); labelsWrap.appendChild(p); }); }

    function renderLabelSelect(){ labelSelect.innerHTML=''; const opt = document.createElement('option'); opt.value=''; opt.textContent='— scegli etichetta —'; labelSelect.appendChild(opt); state.labels.forEach(({name,color})=>{ const o=document.createElement('option'); o.value=name; o.textContent=name; o.dataset.color=color; labelSelect.appendChild(o); }); if (state.lastLabel){ const found=[...labelSelect.options].find(o=>o.value===state.lastLabel); if(found) labelSelect.value=state.lastLabel; } }

    function applyEditability(){ const editable=state.canEdit; [datesInput,labelSelect,newLabel,newColor,addLabelBtn,$('#addDatesBtn'),evTitleInput,evTimeInput,evNote].forEach(el=>{ if(!el) return; el.classList.toggle('disabled',!editable); el.disabled=!editable; }); $('#permInfo').textContent = editable? 'Modalità: editor abilitato' : 'Modalità: sola visualizzazione'; $('#saveNoteBtn').style.display = editable? 'inline-block' : 'none'; $('#deleteEventBtn').style.display = editable? 'inline-block' : 'none'; }

    async function loadCloud(id){ const ref=doc(db,'calendars',id); const snap=await getDoc(ref); if (snap.exists()){ const data=snap.data(); state.events = Array.isArray(data.data)? data.data : []; let changed=false; state.events.forEach(e=>{ if(!e.eid){ e.eid=genEid(); changed=true; }}); if (changed) { await setDoc(ref,{ data: state.events, updatedAt: serverTimestamp() }, { merge:true }); } state.labels = Array.isArray(data.labels)? data.labels : []; if ((data.editCode||'').toUpperCase() !== EDITOR_CODE){ await setDoc(ref,{ editCode: EDITOR_CODE, updatedAt: serverTimestamp() }, { merge:true }); } state.editCode = EDITOR_CODE; } else { state.events=[]; state.labels=[]; state.editCode=EDITOR_CODE; await setDoc(ref,{ data:[], labels:[], editCode: EDITOR_CODE, updatedAt: serverTimestamp() },{ merge:true }); } render(); $('#cloudStatus').textContent='Cloud: caricato'; }

    async function saveCloud(){ if (!state.calId) return; const ref=doc(db,'calendars',state.calId); await setDoc(ref,{ data: state.events, labels: state.labels, editCode: EDITOR_CODE, updatedAt: serverTimestamp() }, { merge:true }); $('#cloudStatus').textContent='Cloud: salvato'; updateCodeStatus(); }

    function subscribe(){ if (state.unsub) { state.unsub(); state.unsub=null; } if (!state.calId) return; const ref=doc(db,'calendars',state.calId); state.unsub = onSnapshot(ref,(snap)=>{ if(!snap.exists()) return; const data=snap.data(); const incomingEv = JSON.stringify(data.data||[]); const incomingLb = JSON.stringify(data.labels||[]); if (incomingEv !== JSON.stringify(state.events)) state.events = (data.data||[]); if (incomingLb !== JSON.stringify(state.labels)) state.labels = data.labels||[]; render(); }); }

    addLabelBtn.addEventListener('click', ()=>{ if (!state.canEdit) return alert('Modalità sola lettura. Sblocca con il codice editor.'); const name=newLabel.value.trim(); const color=newColor.value; if (!name) return alert('Inserisci un nome etichetta.'); const existing = state.labels.find(l=>l.name.toLowerCase()===name.toLowerCase()); if (existing) { existing.color = color; } else { state.labels.push({name,color}); } state.lastLabel = name; newLabel.value=''; renderLabelSelect(); renderLabels(); renderFilterLabelOptions(); saveCloud(); });

    $('#addDatesBtn').addEventListener('click', ()=>{ if (!state.canEdit) return alert('Modalità sola lettura. Sblocca con il codice editor.'); const txt=datesInput.value.trim(); let labelName = labelSelect.value.trim(); let color = '#2563eb'; if (!labelName){ if (newLabel.value.trim()) { labelName = newLabel.value.trim(); color = newColor.value; const ex=state.labels.find(l=>l.name.toLowerCase()===labelName.toLowerCase()); if(!ex) state.labels.push({name:labelName,color}); else color = ex.color; } else if (state.lastLabel) { labelName = state.lastLabel; const opt=[...labelSelect.options].find(o=>o.value===labelName); if(opt && opt.dataset.color) color=opt.dataset.color; } else if (state.labels.length){ labelName = state.labels[0].name; color = state.labels[0].color; } else { labelName = 'Evento'; color = '#2563eb'; state.labels.push({name:labelName,color}); } } else { const opt = [...labelSelect.options].find(o=>o.value===labelName); if (opt && opt.dataset.color) color = opt.dataset.color; } state.lastLabel = labelName; if (!txt) return alert('Incolla almeno una riga.'); const lines=txt.split(/\r?\n/); let ok=0,bad=0; const added=[]; for(const line of lines){ if(!line.trim()) continue; const rec=parseLine(line); if(!rec){ bad++; continue; } const ev = { eid: genEid(), date:rec.date, time:rec.time, title:rec.title, label:labelName, color, note:'' }; state.events.push(ev); added.push(ev); ok++; } if (ok===0) return alert('Nessuna riga valida trovata.'); const first = added.map(e=>new Date(e.date)).sort((a,b)=>a-b)[0]; if (first){ state.current = new Date(first.getFullYear(), first.getMonth(), 1); state.selected = first; } datesInput.value=''; if (bad>0) alert(`${ok} eventi aggiunti. ${bad} righe non riconosciute.`); saveCloud(); render(); });

    // Ricerca & filtro
    searchInput.addEventListener('input', ()=>{ state.searchQuery = searchInput.value.trim().toLowerCase(); render(); });
    filterLabelEl.addEventListener('change', ()=>{ state.filterLabel = filterLabelEl.value; render(); });

    // Modale evento
    function openEvent(eid){ const ev = state.events.find(x=>x.eid===eid); if (!ev) return; state.modalEventId = eid; evTitleInput.value = ev.title || ''; const d=new Date(ev.date); evDate.textContent = d.toLocaleDateString('it-IT',{weekday:'long', day:'2-digit', month:'long', year:'numeric'}); evTimeInput.value = ev.time || ''; evLabel.textContent = ev.label || '—'; evDot.style.background = ev.color || '#999'; evNote.value = ev.note || ''; applyEditability(); eventModal.classList.add('show'); }
    function closeEvent(){ state.modalEventId=null; eventModal.classList.remove('show'); }
    if (closeModalBtn) closeModalBtn.addEventListener('click', closeEvent);
    if (cancelBtn) cancelBtn.addEventListener('click', closeEvent);
    if (eventModal) eventModal.addEventListener('click', (e)=>{ if (e.target===eventModal) closeEvent(); });

    saveNoteBtn.addEventListener('click', ()=>{ if (!state.canEdit) return; const eid = state.modalEventId; if(!eid) return; const ev = state.events.find(x=>x.eid===eid); if(!ev) return; const newTitle = (evTitleInput.value||'').trim(); const newTimeRaw = (evTimeInput.value||'').trim(); const norm = normalizeTime(newTimeRaw); if (newTimeRaw && norm===null) return alert('Formato ora non valido. Usa es. 21:00, 21.00, ore 21, h 21, alle 21.'); ev.title = newTitle; ev.time = norm===null? ev.time : norm; if (!newTimeRaw) ev.time = ''; ev.note = (evNote.value||'').trim(); saveCloud(); closeEvent(); render(); });

    deleteEventBtn.addEventListener('click', ()=>{ if (!state.canEdit) return; const eid = state.modalEventId; if(!eid) return; if (!confirm('Eliminare questo evento?')) return; state.events = state.events.filter(x=>x.eid!==eid); saveCloud(); closeEvent(); render(); });

    // Modale giorno completo
    function openDayModal(iso){ const d=new Date(iso); if (dayModalTitle) dayModalTitle.textContent = d.toLocaleDateString('it-IT',{weekday:'long', day:'2-digit', month:'long', year:'numeric'}); if (!dayModalList) return; dayModalList.innerHTML=''; const evs=eventsOnDateISO(iso).sort(sortByTimeThenTitle); if (!evs.length){ const empty=document.createElement('div'); empty.className='muted'; empty.textContent='Nessun evento per questo giorno'; dayModalList.appendChild(empty); } else { evs.forEach(ev=>{ const row=document.createElement('div'); row.className='dayitem'; row.addEventListener('click',()=>{ openEvent(ev.eid); }); const time=document.createElement('div'); time.className='timebadge'; time.textContent = ev.time || 'Tutto il giorno'; const body=document.createElement('div'); const title=document.createElement('div'); title.style.fontWeight='700'; title.textContent = ev.title || '(senza titolo)'; const lab=document.createElement('span'); lab.className='labelbadge'; lab.innerHTML = `<span class=\"dot\" style=\"background:${ev.color}\"></span>${ev.label||'—'}`; body.appendChild(title); body.appendChild(lab); if (ev.note){ const note=document.createElement('div'); note.className='muted'; note.textContent=ev.note; body.appendChild(note); } row.appendChild(time); row.appendChild(body); dayModalList.appendChild(row); }); } if (dayModal) dayModal.classList.add('show'); }
    function closeDayModal(){ if (dayModal) dayModal.classList.remove('show'); }
    if (closeDayModalBtn) closeDayModalBtn.addEventListener('click', closeDayModal);
    if (dayModal) dayModal.addEventListener('click', (e)=>{ if (e.target===dayModal) closeDayModal(); });

    // Export ICS (all-day)
    $('#exportIcsBtn').addEventListener('click', ()=>{
      const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//PasteCal//IT','CALSCALE:GREGORIAN'];
      const toIcs=iso=>iso.replace(/-/g,'');
      state.events.forEach((e,i)=>{
        const uid=`${toIcs(e.date)}-${e.eid||i}-${Math.random().toString(36).slice(2)}@pastecal`;
        const summary = `${e.time? e.time+' · ' : ''}${e.title? e.title : (e.label||'Evento')}`;
        lines.push('BEGIN:VEVENT');
        lines.push(`UID:${uid}`);
        lines.push(`DTSTAMP:${new Date().toISOString().replace(/[-:]/g,'').replace(/\..+/,'')}Z`);
        lines.push(`DTSTART;VALUE=DATE:${toIcs(e.date)}`);
        lines.push(`SUMMARY:${summary.replace(/\n/g,' ')}`);
        if (e.note){ lines.push(`DESCRIPTION:${e.note.replace(/[\n\r]+/g,' ')}`); }
        lines.push('END:VEVENT');
      });
      lines.push('END:VCALENDAR');
      const blob=new Blob([lines.join('\n')],{type:'text/calendar;charset=utf-8'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='calendario.ics'; document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
    });

    // Condivisione/permessi
    $('#createCalBtn').addEventListener('click', async ()=>{ if (state.calId) return alert('Calendario già creato.'); const id = genId(); state.calId = id; calIdEl.value = id; history.replaceState(null,'',`${location.pathname}?id=${encodeURIComponent(id)}`); await setDoc(doc(db,'calendars',id), { data:[], labels:[], editCode: EDITOR_CODE, updatedAt: serverTimestamp() }, { merge:true }); alert('Calendario creato! Usa il codice editor VIVAGESU per sbloccare.'); subscribe(); render(); });

    $('#copyViewerBtn').addEventListener('click', async ()=>{ if (!state.calId) return alert('Crea o apri un calendario prima.'); const url = `${location.origin}${location.pathname}?id=${encodeURIComponent(state.calId)}`; await navigator.clipboard.writeText(url); alert('Link copiato (sola visualizzazione).'); });

    $('#copyEditorLinkBtn').addEventListener('click', async ()=>{ if (!state.calId) return alert('Crea o apri un calendario prima.'); const url = `${location.origin}${location.pathname}?id=${encodeURIComponent(state.calId)}#code=${encodeURIComponent(EDITOR_CODE)}`; await navigator.clipboard.writeText(url); alert('Link editor copiato.'); });

    $('#unlockBtn').addEventListener('click', ()=>{ if (!state.calId) return alert('Apri prima un calendario (link con ?id=...)'); const inputCode = (editCodeInput.value||'').trim().toUpperCase(); if (!inputCode) return alert('Inserisci il codice editor.'); if (inputCode === EDITOR_CODE){ state.editCode = EDITOR_CODE; state.canEdit = true; updateCodeStatus(); render(); alert('Editor sbloccato.'); } else { alert('Codice non valido.'); } });

    // Navigazione
    function setMonth(delta){ const d=new Date(state.current); d.setMonth(d.getMonth()+delta); state.current=d; render(); }
    $('#prevBtn').addEventListener('click',()=>{ if (state.view==='month') setMonth(-1); else { state.selected.setDate(state.selected.getDate()-(state.view==='week'?7:1)); render(); }});
    $('#nextBtn').addEventListener('click',()=>{ if (state.view==='month') setMonth(1); else { state.selected.setDate(state.selected.getDate()+(state.view==='week'?7:1)); render(); }});
    $('#todayBtn').addEventListener('click',()=>{ state.current=new Date(); state.selected=new Date(); render(); });

    // Switch vista
    viewMonthBtn.addEventListener('click',()=> setView('month'));
    viewWeekBtn.addEventListener('click',()=> setView('week'));
    viewDayBtn.addEventListener('click',()=> setView('day'));

    // Bootstrap: apri da ?id e sblocca da #code
    (async function init(){
      const urlParams = new URLSearchParams(location.search);
      const initialId = urlParams.get('id');
      if (initialId){
        state.calId = initialId;
        calIdEl.value = initialId;
        await loadCloud(initialId);
        subscribe();
        const hash = new URLSearchParams(location.hash.replace('#','?'));
        const c = (hash.get('code')||'').toUpperCase();
        if (c === EDITOR_CODE){ state.editCode = EDITOR_CODE; state.canEdit = true; }
      }
      render();
    })();
  </script>
</body>
</html>
